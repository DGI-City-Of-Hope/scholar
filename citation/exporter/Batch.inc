<?php

/**
 * @file
 *
 * A collection of functions for batch processing files to generate the appropriate file for exporting.
 */

/**
 * Exports a collection of citations to a file.
 * 
 * Launches a Batch process from a submit callback. Otherwise the callee must also call batch_process().
 * 
 * @param array $pids
 *   The collection of citations to export to file.
 * @param string $style
 *   The style to apply to the citation for exporting to a file.
 * @param string $file_format 
 *   The format of the exported file.
 */
function citation_exporter_batch_export(array $pids, $style, $file_format) {
  $operations = array();
  switch ($file_format) {
    case 'RIS':
      module_load_include('inc', 'citation_exporter', 'BatchExportRIS');
      $operations = citation_exporter_batch_get_ris_operations();
      break;
    case 'RTF':
      module_load_include('inc', 'citation_exporter', 'BatchExportRTF');
      $operations = citation_exporter_batch_get_rtf_operations($pids, $style);
      break;
    case 'PDF':
      module_load_include('inc', 'citation_exporter', 'BatchExportPDF');
      $operations = citation_exporter_batch_get_pdf_operations();
      break;
  }
  if (count($operations) > 0) {
    $batch = array(
      'title' => t('Exporting Citations to File'),
      'operations' => $operations,
      'finished' => 'citation_exporter_batch_finished'
    );
    batch_set($batch);
  }
}

/**
 *
 * @param type $redirect
 * @param array $context 
 */
function citation_exporter_batch_redirect($redirect, array &$context) {
  $context['results']['redirect'] = $redirect;
}

/**
 * Prepare the file generated by the batch process to be downloaded.
 * 
 * @param boolean $successful
 *   Was the batch process succesful?
 * @param array $results
 *   The results returned from the batch process.
 * @param array $operations
 *   The operations that were part of the batch process.
 */
function citation_exporter_batch_finished($successful, array $results, array $operations) {
  module_load_include('inc', 'citation_exporter', 'CitationExporter');
  if ($successful) {
    CitationExporter::PrepareToExport($results['filename'], $results['mime_type'], $results['download_filename'], $results['redirect']);
  }
}